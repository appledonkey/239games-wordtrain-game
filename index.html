<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÇ Word Train</title>
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kalam', cursive;
            background: linear-gradient(135deg, #F5F3F0 0%, #E8E6E3 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Particles for celebrations */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            border-radius: 50%;
            animation: particleFloat 2s ease-out forwards;
        }

        .particle.sparkle {
            background: radial-gradient(circle, gold, orange);
            box-shadow: 0 0 6px gold;
        }

        .particle.confetti {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffd93d);
        }

        @keyframes particleFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translateY(-100px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-200px) scale(0.2);
            }
        }

        /* Floating score numbers */
        .floating-score {
            position: absolute;
            font-size: 1.8rem;
            font-weight: 700;
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            pointer-events: none;
            z-index: 999;
            animation: floatUp 2s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.2);
            }
        }

        /* Screen shake for genius connections */
        .screen-shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-8px) rotate(-1deg); }
            20% { transform: translateX(8px) rotate(1deg); }
            30% { transform: translateX(-8px) rotate(-1deg); }
            40% { transform: translateX(8px) rotate(1deg); }
            50% { transform: translateX(-8px) rotate(-1deg); }
            60% { transform: translateX(8px) rotate(1deg); }
            70% { transform: translateX(-8px) rotate(-1deg); }
            80% { transform: translateX(8px) rotate(1deg); }
            90% { transform: translateX(-8px) rotate(-1deg); }
        }

        /* RailBound-inspired Color Palette */
        :root {
            --primary-peach: #F4A57A;
            --primary-mint: #9BC5A2;
            --primary-lavender: #B5A7E6;
            --soft-cream: #F8F6F2;
            --warm-brown: #8B7355;
            --muted-coral: #E89C85;
            --pale-blue: #A8C8EC;
            --soft-yellow: #F2E5A2;
            --gentle-pink: #E6B3C7;
        }

        /* Title Screen */
        #titleScreen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            background: linear-gradient(45deg, var(--primary-peach), var(--primary-mint), var(--primary-lavender), var(--pale-blue));
            background-size: 400% 400%;
            animation: gentleShift 12s ease infinite;
        }

        @keyframes gentleShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .title-logo {
            font-size: 4rem;
            font-weight: 700;
            color: var(--soft-cream);
            text-shadow: 3px 3px 0px var(--warm-brown), 6px 6px 8px rgba(0,0,0,0.2);
            margin-bottom: 2rem;
            transform: rotate(-3deg);
            border: 4px solid var(--warm-brown);
            background: rgba(255,255,255,0.1);
            padding: 1.5rem 2rem;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .title-logo:hover {
            transform: rotate(0deg) scale(1.05);
        }

        .subtitle {
            font-size: 1.4rem;
            color: var(--warm-brown);
            margin-bottom: 3rem;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.8);
            padding: 1rem 1.5rem;
            border-radius: 15px;
            border: 3px solid var(--warm-brown);
            max-width: 600px;
        }

        .start-btn {
            background: var(--primary-mint);
            color: var(--warm-brown);
            border: 4px solid var(--warm-brown);
            padding: 1.2rem 2rem;
            font-size: 1.5rem;
            font-family: 'Kalam', cursive;
            font-weight: 700;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 6px 6px 0px var(--warm-brown);
            transform: rotate(-2deg);
            transition: all 0.2s ease;
            margin: 0.5rem;
        }

        .start-btn:hover {
            transform: rotate(1deg) translateY(-3px);
            box-shadow: 8px 8px 0px var(--warm-brown);
        }

        .start-btn:active {
            transform: rotate(0deg) translateY(0px);
            box-shadow: 3px 3px 0px var(--warm-brown);
        }

        .branding {
            position: absolute;
            bottom: 30px;
            right: 30px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--warm-brown);
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.7);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 2px solid var(--warm-brown);
        }

        /* Game Screen */
        #gameScreen {
            display: none;
            min-height: 100vh;
            padding: 30px;
            position: relative;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            background: var(--soft-cream);
            padding: 1.5rem;
            border-radius: 25px;
            box-shadow: 4px 4px 0px var(--warm-brown);
            border: 3px solid var(--warm-brown);
            transition: all 0.3s ease;
        }

        .score-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--muted-coral);
            transition: all 0.3s ease;
        }

        .score-display.score-increase {
            animation: scoreIncrease 0.6s ease;
        }

        @keyframes scoreIncrease {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); color: #ff6b6b; }
            100% { transform: scale(1); }
        }

        .combo-display {
            font-size: 1.4rem;
            color: var(--primary-mint);
            font-weight: 700;
        }

        .ai-status {
            font-size: 1rem;
            color: var(--warm-brown);
            background: var(--soft-yellow);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 2px solid var(--warm-brown);
            transition: all 0.3s ease;
        }

        /* Enhanced Train Scene */
        .train-scene {
            background: linear-gradient(to bottom, var(--pale-blue) 0%, var(--soft-cream) 70%, var(--primary-mint) 100%);
            border-radius: 30px;
            padding: 3rem;
            margin-bottom: 3rem;
            min-height: 250px;
            position: relative;
            overflow-x: auto;
            border: 4px solid var(--warm-brown);
            box-shadow: 6px 6px 0px rgba(139, 115, 85, 0.4);
            transition: all 0.5s ease;
        }

        /* Enhanced cloud decorations with animation */
        .train-scene::before {
            content: '‚òÅÔ∏è ‚òÅÔ∏è ‚òÅÔ∏è';
            position: absolute;
            top: 30px;
            right: 40px;
            font-size: 2rem;
            opacity: 0.6;
            animation: cloudFloat 8s ease-in-out infinite;
        }

        @keyframes cloudFloat {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(30px); }
        }

        .train-track {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            height: 30px;
            display: flex;
            align-items: center;
        }

        .rail-segment {
            width: 40px;
            height: 14px;
            background: var(--warm-brown);
            margin: 0 4px;
            border-radius: 7px;
            border: 2px solid #6B5D47;
            position: relative;
            animation: railGrow 0.5s ease-in-out;
        }

        @keyframes railGrow {
            0% { width: 0; opacity: 0; }
            100% { width: 40px; opacity: 1; }
        }

        .rail-segment::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 5px;
            height: 5px;
            background: #5A4D3A;
            border-radius: 50%;
        }

        /* Enhanced Train Container with smooth movement */
        .train-container {
            position: absolute;
            bottom: 110px;
            left: 60px;
            display: flex;
            align-items: flex-end;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .train-container.moving {
            animation: trainChug 2s ease-in-out;
        }

        @keyframes trainChug {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-3px); }
            75% { transform: translateY(-1px); }
        }

        /* Enhanced train elements */
        .train-engine {
            width: 100px;
            height: 80px;
            background: linear-gradient(45deg, var(--muted-coral), var(--primary-peach));
            border-radius: 20px 20px 8px 8px;
            position: relative;
            margin-right: 10px;
            border: 4px solid var(--warm-brown);
            box-shadow: 3px 3px 0px rgba(139, 115, 85, 0.8);
            transform: perspective(120px) rotateY(-5deg);
            animation: engineBreathe 3s ease-in-out infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        @keyframes engineBreathe {
            0%, 100% { box-shadow: 3px 3px 0px rgba(139, 115, 85, 0.8); }
            50% { box-shadow: 5px 5px 10px rgba(139, 115, 85, 0.6); }
        }

        .engine-word {
            font-size: 1rem;
            font-weight: 700;
            color: var(--warm-brown);
            text-shadow: 1px 1px 1px rgba(255,255,255,0.7);
            margin-bottom: 0.2rem;
        }

        .engine-emoji {
            font-size: 1.8rem;
        }

        .train-car {
            min-width: 90px;
            max-width: 120px;
            height: 70px;
            background: linear-gradient(45deg, var(--primary-mint), var(--pale-blue));
            border-radius: 15px 15px 6px 6px;
            margin-right: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--warm-brown);
            text-shadow: 1px 1px 1px rgba(255,255,255,0.7);
            border: 3px solid var(--warm-brown);
            box-shadow: 3px 3px 0px rgba(139, 115, 85, 0.8);
            word-wrap: break-word;
            overflow: hidden;
            transition: all 0.3s ease;
            transform: perspective(120px) rotateY(-3deg);
            padding: 0.3rem;
            text-align: center;
            line-height: 1.1;
            animation: carAttach 0.8s ease-out;
        }

        @keyframes carAttach {
            0% {
                opacity: 0;
                transform: perspective(120px) rotateY(-3deg) translateX(-30px);
            }
            50% {
                transform: perspective(120px) rotateY(-3deg) translateX(8px);
            }
            100% {
                opacity: 1;
                transform: perspective(120px) rotateY(-3deg) translateX(0);
            }
        }

        .train-car.combo {
            background: linear-gradient(45deg, var(--primary-lavender), var(--gentle-pink));
            animation: gentlePulse 2s infinite, carAttach 0.8s ease-out;
            border-color: var(--muted-coral);
        }

        .train-car.genius {
            background: linear-gradient(45deg, var(--soft-yellow), var(--primary-peach));
            animation: geniusGlow 1.5s infinite, carAttach 0.8s ease-out;
            border-color: gold;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6), 3px 3px 0px rgba(139, 115, 85, 0.8);
        }

        @keyframes gentlePulse {
            0%, 100% { transform: perspective(120px) rotateY(-3deg) scale(1); }
            50% { transform: perspective(120px) rotateY(-3deg) scale(1.05); }
        }

        @keyframes geniusGlow {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.6), 3px 3px 0px rgba(139, 115, 85, 0.8);
                transform: perspective(120px) rotateY(-3deg) scale(1);
            }
            50% { 
                box-shadow: 0 0 25px rgba(255, 215, 0, 0.9), 3px 3px 0px rgba(139, 115, 85, 0.8);
                transform: perspective(120px) rotateY(-3deg) scale(1.08);
            }
        }

        /* Dual Connection Rules Display */
        .rules-display {
            text-align: center;
            margin-bottom: 2rem;
            background: var(--soft-cream);
            padding: 1.5rem;
            border-radius: 20px;
            border: 3px solid var(--warm-brown);
            box-shadow: 4px 4px 0px rgba(139, 115, 85, 0.3);
        }

        .rules-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--muted-coral);
            margin-bottom: 1rem;
        }

        .rules-text {
            font-size: 1.1rem;
            color: var(--warm-brown);
            line-height: 1.4;
        }

        .connection-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .engine-connection {
            background: var(--primary-peach);
            color: var(--warm-brown);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 2px solid var(--warm-brown);
        }

        .previous-connection {
            background: var(--primary-mint);
            color: var(--warm-brown);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 2px solid var(--warm-brown);
        }

        /* Enhanced Game Controls */
        .game-controls {
            background: var(--soft-cream);
            padding: 2.5rem;
            border-radius: 30px;
            border: 4px solid var(--warm-brown);
            box-shadow: 6px 6px 0px rgba(139, 115, 85, 0.4);
            margin-bottom: 3rem;
            transition: all 0.3s ease;
        }

        .current-word {
            text-align: center;
            margin-bottom: 2rem;
        }

        .current-word h3 {
            font-size: 1.4rem;
            color: var(--warm-brown);
            margin-bottom: 0.8rem;
        }

        .current-word .word {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--muted-coral);
            text-shadow: 2px 2px 0px var(--warm-brown), 4px 4px 8px rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.3);
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            border: 3px solid var(--warm-brown);
            display: inline-block;
            transition: all 0.3s ease;
        }

        .input-section {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            align-items: center;
        }

        #wordInput {
            flex: 1;
            padding: 1.5rem;
            font-size: 1.6rem;
            font-family: 'Kalam', cursive;
            border: 4px solid var(--primary-mint);
            border-radius: 25px;
            outline: none;
            background: rgba(255,255,255,0.9);
            color: var(--warm-brown);
            box-shadow: inset 3px 3px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        #wordInput:focus {
            border-color: var(--muted-coral);
            box-shadow: 0 0 12px rgba(244, 165, 122, 0.5), inset 3px 3px 6px rgba(0,0,0,0.1);
            transform: scale(1.02);
        }

        .submit-btn {
            background: var(--primary-mint);
            color: var(--warm-brown);
            border: 4px solid var(--warm-brown);
            padding: 1.5rem 2rem;
            font-size: 1.3rem;
            font-family: 'Kalam', cursive;
            font-weight: 700;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 4px 4px 0px var(--warm-brown);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px var(--warm-brown);
        }

        .submit-btn:active {
            transform: translateY(1px);
            box-shadow: 2px 2px 0px var(--warm-brown);
        }

        .action-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            background: var(--primary-lavender);
            color: var(--warm-brown);
            border: 3px solid var(--warm-brown);
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            font-family: 'Kalam', cursive;
            font-weight: 700;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 3px 3px 0px rgba(139, 115, 85, 0.7);
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 4px 4px 0px rgba(139, 115, 85, 0.7);
        }

        .action-btn:active {
            transform: translateY(1px);
            box-shadow: 1px 1px 0px rgba(139, 115, 85, 0.7);
        }

        /* Enhanced Feedback Messages */
        .feedback-message {
            background: var(--primary-mint);
            color: var(--warm-brown);
            padding: 1.5rem;
            border-radius: 20px;
            border: 3px solid var(--warm-brown);
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            animation: feedbackSlide 0.6s ease;
            box-shadow: 3px 3px 0px rgba(139, 115, 85, 0.5);
            position: relative;
            overflow: hidden;
        }

        @keyframes feedbackSlide {
            0% { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.9); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .feedback-message.success {
            background: var(--soft-yellow);
        }

        .feedback-message.genius {
            background: linear-gradient(135deg, gold, var(--soft-yellow));
            color: var(--warm-brown);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4), 3px 3px 0px rgba(139, 115, 85, 0.5);
            animation: feedbackSlide 0.6s ease, geniusPulse 2s ease-in-out infinite;
        }

        @keyframes geniusPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        .feedback-message.error {
            background: var(--muted-coral);
            color: white;
        }

        /* Enhanced Game Over Screen */
        .game-over {
            display: none;
            text-align: center;
            background: var(--soft-cream);
            padding: 4rem;
            border-radius: 30px;
            border: 4px solid var(--warm-brown);
            box-shadow: 8px 8px 0px rgba(139, 115, 85, 0.5);
            margin: 3rem 0;
            animation: gameOverSlide 0.6s ease;
        }

        @keyframes gameOverSlide {
            0% { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .crash-animation {
            font-size: 5rem;
            margin-bottom: 2rem;
            animation: celebrationBounce 1s ease-in-out;
        }

        @keyframes celebrationBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-15px) rotate(-8deg); }
            75% { transform: translateY(-8px) rotate(8deg); }
        }

        .final-stats {
            margin: 3rem 0;
        }

        .stat-item {
            font-size: 1.3rem;
            margin: 1rem 0;
            color: var(--warm-brown);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: scale(1.05);
        }

        .stat-value {
            font-weight: 700;
            color: var(--muted-coral);
        }

        /* Enhanced Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--soft-cream);
            padding: 3rem;
            border-radius: 30px;
            border: 4px solid var(--warm-brown);
            box-shadow: 10px 10px 0px rgba(139, 115, 85, 0.6);
            max-width: 600px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.4s ease;
        }

        @keyframes modalSlideIn {
            0% { 
                transform: translate(-50%, -50%) scale(0.8); 
                opacity: 0; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(1); 
                opacity: 1; 
            }
        }

        .modal h3 {
            color: var(--muted-coral);
            margin-bottom: 1.5rem;
            font-size: 1.6rem;
        }

        #explanationInput {
            width: 100%;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-family: 'Kalam', cursive;
            border: 3px solid var(--primary-mint);
            border-radius: 20px;
            outline: none;
            color: var(--warm-brown);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        #explanationInput:focus {
            border-color: var(--muted-coral);
            box-shadow: 0 0 10px rgba(244, 165, 122, 0.4);
        }

        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .title-logo {
                font-size: 3rem;
            }
            
            .current-word .word {
                font-size: 2.2rem;
            }
            
            .input-section {
                flex-direction: column;
                gap: 1rem;
            }
            
            #wordInput {
                font-size: 1.4rem;
                padding: 1.2rem;
            }
            
            .train-car, .train-engine {
                font-size: 0.8rem;
                min-width: 70px;
                max-width: 90px;
                height: 60px;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .action-btn {
                width: 90%;
                max-width: 250px;
            }

            .game-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .train-scene {
                padding: 2rem;
                min-height: 200px;
            }

            .game-controls {
                padding: 2rem;
            }
        }

        @media (max-width: 480px) {
            .train-scene {
                padding: 1.5rem;
                min-height: 180px;
            }

            .game-controls {
                padding: 1.5rem;
            }

            .modal {
                padding: 2rem;
                margin: 20px;
                width: calc(100% - 40px);
            }

            .connection-display {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Title Screen -->
    <div id="titleScreen">
        <div class="title-logo">üöÇ WORD TRAIN</div>
        <div class="subtitle">
            <strong>Dual Connection Challenge!</strong><br>
            Every word must connect to BOTH the engine AND the previous car.<br>
            Think strategically - one wrong move and your train derails!
        </div>
        
        <button class="start-btn" onclick="startGame()">üéÆ Start Challenge</button>
        
        <div class="branding">239 GAMES</div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen">
        <div class="game-header">
            <div class="score-display">Score: <span id="currentScore">0</span></div>
            <div class="combo-display">Chain: <span id="chainLength">1</span></div>
            <div class="ai-status" id="aiStatus">ü§ñ Claude AI</div>
        </div>

        <div class="rules-display">
            <div class="rules-title">üéØ Dual Connection Rule</div>
            <div class="rules-text">
                Your next word must connect to BOTH:
            </div>
            <div class="connection-display">
                <div class="engine-connection">üöÇ <span id="engineWord">STAR</span></div>
                <div style="font-size: 2rem;">+</div>
                <div class="previous-connection">üöÉ <span id="previousWord">STAR</span></div>
            </div>
        </div>

        <div class="train-scene" id="trainScene">
            <div class="train-track" id="trainTrack"></div>
            <div class="train-container" id="trainContainer">
                <div class="train-engine">
                    <div class="engine-word" id="engineDisplay">STAR</div>
                    <div class="engine-emoji">‚≠ê</div>
                </div>
            </div>
        </div>

        <div class="game-controls">
            <div class="current-word">
                <h3>Add your next car:</h3>
                <div class="word" id="currentWordDisplay">Ready to build?</div>
            </div>

            <div id="feedbackContainer"></div>

            <div class="input-section">
                <input type="text" id="wordInput" placeholder="Enter word that connects to BOTH..." maxlength="50">
                <button class="submit-btn" id="submitBtn" onclick="submitWord()">üöÉ Add Car</button>
            </div>

            <div class="action-buttons">
                <button class="action-btn" onclick="newGame()">üÜï New Challenge</button>
                <button class="action-btn" onclick="goHome()">üè† Home</button>
            </div>
        </div>

        <div class="game-over" id="gameOverScreen">
            <div class="crash-animation">üéØüèÜ‚ú®</div>
            <h2 style="color: var(--muted-coral); margin-bottom: 1rem;">Challenge Complete!</h2>
            <div class="final-stats">
                <div class="stat-item">Final Score: <span class="stat-value" id="finalScore">0</span></div>
                <div class="stat-item">Chain Length: <span class="stat-value" id="finalChain">0</span></div>
                <div class="stat-item">Engine Word: <span class="stat-value" id="finalEngine">STAR</span></div>
                <div class="stat-item">Genius Connections: <span class="stat-value" id="geniusCount">0</span></div>
            </div>
            <button class="start-btn" onclick="newGame()">üéÆ New Challenge</button>
            <button class="start-btn" onclick="goHome()">üè† Home</button>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div class="modal-overlay" id="explanationModal">
        <div class="modal">
            <h3>Explain Your Dual Connection</h3>
            <p>How does "<span id="connectionWords"></span>" connect to BOTH the engine and previous car?</p>
            <textarea id="explanationInput" placeholder="Explain both connections..."></textarea>
            <div style="margin-top: 1.5rem;">
                <button class="submit-btn" onclick="submitExplanation()">Submit</button>
                <button class="action-btn" onclick="skipExplanation()" style="margin-left: 1rem;">Skip (-1 pt)</button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            score: 0,
            engineWord: '',
            currentWord: '',
            wordChain: [],
            isGameActive: false,
            geniusCount: 0,
            pendingConnection: null
        };

        // Your API URL
        const API_URL = 'https://239games-wordtrain-fy0wlsk63-james-oswalds-projects.vercel.app/api/judge';

        // Engine words for starting the game
        const ENGINE_WORDS = [
            { word: 'STAR', emoji: '‚≠ê' },
            { word: 'FIRE', emoji: 'üî•' },
            { word: 'OCEAN', emoji: 'üåä' },
            { word: 'MUSIC', emoji: 'üéµ' },
            { word: 'LIGHT', emoji: 'üí°' },
            { word: 'BOOK', emoji: 'üìö' },
            { word: 'TREE', emoji: 'üå≥' },
            { word: 'STONE', emoji: 'ü™®' }
        ];

        // Sound effects
        class SoundEffects {
            static play(type) {
                if (!window.AudioContext && !window.webkitAudioContext) return;
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'success':
                        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        break;
                    case 'genius':
                        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
                        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        break;
                    case 'whoosh':
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.3);
                        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        break;
                }
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            static vibrate(pattern = [100]) {
                if (navigator.vibrate) {
                    navigator.vibrate(pattern);
                }
            }
        }

        // Particle effects
        function createParticles(element, type, count = 15) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = `particle ${type}`;
                
                const size = Math.random() * 10 + 6;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                particle.style.left = centerX + (Math.random() - 0.5) * 120 + 'px';
                particle.style.top = centerY + (Math.random() - 0.5) * 120 + 'px';
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 2000);
            }
        }

        // Floating score animation
        function showFloatingScore(points, element) {
            const rect = element.getBoundingClientRect();
            const floatingScore = document.createElement('div');
            floatingScore.className = 'floating-score';
            floatingScore.textContent = '+' + points;
            
            floatingScore.style.left = (rect.left + rect.width / 2) + 'px';
            floatingScore.style.top = rect.top + 'px';
            
            if (points >= 8) {
                floatingScore.style.color = 'gold';
                floatingScore.style.fontSize = '2.5rem';
            }
            
            document.body.appendChild(floatingScore);
            
            setTimeout(() => {
                if (floatingScore.parentNode) {
                    floatingScore.parentNode.removeChild(floatingScore);
                }
            }, 2000);
        }

        // Screen shake effect
        function shakeScreen() {
            document.body.classList.add('screen-shake');
            setTimeout(() => {
                document.body.classList.remove('screen-shake');
            }, 500);
        }

        function capitalizePhrase(phrase) {
            return phrase
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        function validateInput(input) {
            const trimmed = input.trim();
            
            if (!trimmed) {
                return { valid: false, reason: 'Please enter a word or phrase' };
            }

            const words = trimmed.split(/\s+/);
            if (words.length > 3) {
                return { valid: false, reason: 'Maximum 3 words allowed' };
            }

            if (!/^[a-zA-Z\s'-]+$/.test(trimmed)) {
                return { valid: false, reason: 'Letters, spaces, hyphens and apostrophes only' };
            }

            const normalizedInput = trimmed.toLowerCase();
            if (gameState.wordChain.map(w => w.toLowerCase()).includes(normalizedInput)) {
                return { valid: false, reason: 'Already used this word/phrase' };
            }

            const fillerWords = ['the', 'and', 'but', 'for', 'are', 'with', 'his', 'they', 'this', 'have', 'from', 'not', 'was', 'been', 'can', 'a', 'an'];
            if (words.length === 1 && fillerWords.includes(normalizedInput)) {
                return { valid: false, reason: 'Not a meaningful content word' };
            }

            return { valid: true, normalized: capitalizePhrase(trimmed) };
        }

        // Enhanced AI Judge for Dual Connections
        class AIJudge {
            static async judge(engineWord, previousWord, newPhrase) {
                const validation = validateInput(newPhrase);
                if (!validation.valid) {
                    return { result: 'explain', reason: validation.reason, points: 0 };
                }

                try {
                    return await this.judgeWithAI(engineWord, previousWord, validation.normalized);
                } catch (error) {
                    console.log('AI judge failed, using local judge:', error);
                    return this.judgeLocally(engineWord, previousWord, validation.normalized);
                }
            }

            static async judgeWithAI(engineWord, previousWord, newPhrase) {
                document.getElementById('aiStatus').innerHTML = 'ü§ñ AI Thinking<span class="loading-dots">...</span>';
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prevWord: `ENGINE: ${engineWord}, PREVIOUS: ${previousWord}`,
                            newPhrase: newPhrase
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    document.getElementById('aiStatus').textContent = 'ü§ñ Claude AI';
                    
                    return { 
                        result: 'accept', 
                        reason: result.reason || 'Dual connection accepted!', 
                        points: Math.min(10, Math.max(1, result.points || 3))
                    };
                    
                } catch (error) {
                    console.log('AI API failed:', error);
                    document.getElementById('aiStatus').textContent = 'ü§ñ Local Judge (AI Failed)';
                    throw error;
                }
            }

            static judgeLocally(engineWord, previousWord, newPhrase) {
                // For local judging, we'll be more generous but still check basic connections
                const engineConnection = this.checkConnection(engineWord.toLowerCase(), newPhrase.toLowerCase());
                const previousConnection = this.checkConnection(previousWord.toLowerCase(), newPhrase.toLowerCase());
                
                if (engineConnection.found && previousConnection.found) {
                    return { 
                        result: 'accept', 
                        reason: `Great dual connection! Links to both ${engineWord} and ${previousWord}`, 
                        points: Math.max(engineConnection.points, previousConnection.points) + 2 
                    };
                } else if (engineConnection.found || previousConnection.found) {
                    return { 
                        result: 'accept', 
                        reason: `Good connection! Links to ${engineConnection.found ? engineWord : previousWord}`, 
                        points: Math.max(engineConnection.points, previousConnection.points)
                    };
                } else {
                    return { result: 'explain', reason: 'Explain how this connects to both words', points: 0 };
                }
            }

            static checkConnection(word1, word2) {
                // Basic connection checking
                if (word1.includes(word2) || word2.includes(word1)) {
                    return { found: true, points: 4 };
                }
                
                // Sound similarity
                if (this.soundSimilar(word1, word2)) {
                    return { found: true, points: 3 };
                }

                // Length-based creative bonus
                if (word2.length >= 8) {
                    return { found: true, points: 5 };
                }

                return { found: false, points: 0 };
            }

            static soundSimilar(word1, word2) {
                if (word1.length < 3 || word2.length < 3) return false;
                const end1 = word1.slice(-2);
                const end2 = word2.slice(-2);
                return end1 === end2 && word1 !== word2;
            }

            static validateExplanation(explanation, engineWord, previousWord, newWord) {
                if (!explanation || explanation.trim().length < 10) {
                    return { result: 'accept', reason: 'Brief explanation accepted!', points: 3 };
                }

                const length = explanation.trim().length;
                if (length > 50) {
                    return { result: 'accept', reason: 'Excellent detailed explanation!', points: 8 };
                } else if (length > 30) {
                    return { result: 'accept', reason: 'Good explanation!', points: 6 };
                } else {
                    return { result: 'accept', reason: 'Creative connection!', points: 4 };
                }
            }
        }

        // Game Functions
        function startGame() {
            const engineChoice = ENGINE_WORDS[Math.floor(Math.random() * ENGINE_WORDS.length)];
            
            gameState = {
                score: 0,
                engineWord: engineChoice.word,
                engineEmoji: engineChoice.emoji,
                currentWord: engineChoice.word,
                wordChain: [],
                isGameActive: true,
                geniusCount: 0,
                pendingConnection: null
            };

            document.getElementById('titleScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gameOverScreen').style.display = 'none';

            updateDisplay();
            generateTrack();
            
            document.getElementById('wordInput').focus();
            SoundEffects.play('whoosh');
        }

        async function submitWord() {
            const input = document.getElementById('wordInput');
            const newPhrase = input.value.trim();
            
            if (!newPhrase || !gameState.isGameActive) return;

            input.value = '';
            
            const judgment = await AIJudge.judge(gameState.engineWord, gameState.currentWord, newPhrase);
            
            if (judgment.result === 'accept') {
                const validation = validateInput(newPhrase);
                acceptWord(validation.normalized, judgment);
            } else {
                askForExplanation(newPhrase, judgment);
            }
        }

        function acceptWord(newPhrase, judgment) {
            const finalPoints = judgment.points;
            
            gameState.score += finalPoints;
            gameState.wordChain.push(newPhrase);
            gameState.currentWord = newPhrase;

            if (judgment.points >= 8) {
                gameState.geniusCount++;
            }
            
            addTrainCar(newPhrase, judgment.points >= 6, judgment.points >= 8);
            
            const trainContainer = document.getElementById('trainContainer');
            trainContainer.classList.add('moving');
            setTimeout(() => trainContainer.classList.remove('moving'), 2000);

            if (judgment.points >= 9) {
                shakeScreen();
                createParticles(trainContainer, 'confetti', 25);
                SoundEffects.play('genius');
                SoundEffects.vibrate([100, 50, 100]);
            } else if (judgment.points >= 7) {
                createParticles(trainContainer, 'sparkle', 18);
                SoundEffects.play('success');
                SoundEffects.vibrate([100]);
            } else if (judgment.points >= 4) {
                SoundEffects.play('success');
            }

            showFloatingScore(finalPoints, trainContainer);
            
            const scoreDisplay = document.getElementById('currentScore');
            scoreDisplay.parentElement.classList.add('score-increase');
            setTimeout(() => {
                scoreDisplay.parentElement.classList.remove('score-increase');
            }, 600);

            const feedbackClass = judgment.points >= 8 ? 'genius' : 'success';
            const emoji = judgment.points >= 9 ? 'üèÜ' : judgment.points >= 7 ? '‚≠ê' : judgment.points >= 5 ? 'üåü' : '‚ú®';
            showFeedback(`${emoji} ${judgment.reason}! +${finalPoints} points`, feedbackClass);
            
            updateDisplay();
            generateTrack();
            
            document.getElementById('wordInput').focus();
        }

        function askForExplanation(newPhrase, judgment) {
            const validation = validateInput(newPhrase);
            const displayPhrase = validation.valid ? validation.normalized : newPhrase;
            
            gameState.pendingConnection = { word: displayPhrase, judgment: judgment };
            
            document.getElementById('connectionWords').textContent = displayPhrase;
            document.getElementById('explanationInput').value = '';
            document.getElementById('explanationModal').style.display = 'block';
            document.getElementById('explanationInput').focus();
        }

        function submitExplanation() {
            const explanation = document.getElementById('explanationInput').value.trim();
            const connection = gameState.pendingConnection;
            
            if (!connection) return;
            
            const explanationJudgment = AIJudge.validateExplanation(
                explanation, 
                gameState.engineWord, 
                gameState.currentWord, 
                connection.word
            );
            
            document.getElementById('explanationModal').style.display = 'none';
            gameState.pendingConnection = null;
            
            acceptWord(connection.word, explanationJudgment);
        }

        function skipExplanation() {
            const connection = gameState.pendingConnection;
            document.getElementById('explanationModal').style.display = 'none';
            gameState.pendingConnection = null;
            
            const skipJudgment = { points: 2, reason: 'Connection accepted!' };
            acceptWord(connection.word, skipJudgment);
        }

        function showGameOver() {
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalChain').textContent = gameState.wordChain.length + 1;
            document.getElementById('finalEngine').textContent = gameState.engineWord;
            document.getElementById('geniusCount').textContent = gameState.geniusCount;
            
            document.getElementById('gameOverScreen').style.display = 'block';
        }

        function addTrainCar(phrase, isCombo, isGenius) {
            const trainContainer = document.getElementById('trainContainer');
            
            const car = document.createElement('div');
            let carClass = 'train-car';
            if (isGenius) carClass += ' genius';
            else if (isCombo) carClass += ' combo';
            
            car.className = carClass;
            
            const words = phrase.split(' ');
            if (words.length > 2) {
                car.style.fontSize = '0.7rem';
                car.innerHTML = words.join('<br>');
            } else if (words.length === 2) {
                car.style.fontSize = '0.8rem';
                car.innerHTML = words.join('<br>');
            } else {
                car.textContent = phrase.length > 10 ? phrase.substring(0, 10) + '‚Ä¶' : phrase;
            }
            
            trainContainer.appendChild(car);
            
            const currentCars = trainContainer.querySelectorAll('.train-car').length;
            if (currentCars > 6) {
                trainContainer.style.left = (60 - (currentCars - 6) * 40) + 'px';
            }
        }

        function generateTrack() {
            const track = document.getElementById('trainTrack');
            track.innerHTML = '';
            
            const segments = Math.floor(gameState.score / 8) + gameState.wordChain.length;
            
            for (let i = 0; i < segments; i++) {
                const segment = document.createElement('div');
                segment.className = 'rail-segment';
                segment.style.animationDelay = (i * 0.1) + 's';
                track.appendChild(segment);
            }
        }

        function showFeedback(message, type) {
            const container = document.getElementById('feedbackContainer');
            container.innerHTML = `<div class="feedback-message ${type}">${message}</div>`;
            
            setTimeout(() => {
                if (container.innerHTML.includes(message)) {
                    container.innerHTML = '';
                }
            }, 6000);
        }

        function updateDisplay() {
            document.getElementById('currentScore').textContent = gameState.score;
            document.getElementById('chainLength').textContent = gameState.wordChain.length + 1;
            document.getElementById('currentWordDisplay').textContent = gameState.wordChain.length === 0 ? 'Ready to build?' : `Last: ${gameState.currentWord}`;
            
            // Update engine displays
            document.getElementById('engineWord').textContent = gameState.engineWord;
            document.getElementById('previousWord').textContent = gameState.currentWord;
            document.getElementById('engineDisplay').textContent = gameState.engineWord;
            
            // Update engine emoji if it exists
            const engineEmoji = document.querySelector('.engine-emoji');
            if (engineEmoji && gameState.engineEmoji) {
                engineEmoji.textContent = gameState.engineEmoji;
            }
        }

        function newGame() {
            const trainContainer = document.getElementById('trainContainer');
            trainContainer.style.left = '60px';
            trainContainer.style.transform = 'none';
            
            const cars = trainContainer.querySelectorAll('.train-car');
            cars.forEach(car => car.remove());
            
            startGame();
        }

        function goHome() {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('titleScreen').style.display = 'flex';
        }

        // Event Listeners
        document.getElementById('wordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitWord();
            }
        });

        document.getElementById('explanationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitExplanation();
            }
        });

        document.getElementById('explanationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                skipExplanation();
            }
        });

        // Initialize game
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('titleScreen').style.display = 'flex';
        });

        // Loading dots animation
        const style = document.createElement('style');
        style.textContent = `
            .loading-dots {
                display: inline-block;
                animation: loadingDots 1.4s infinite;
            }

            @keyframes loadingDots {
                0%, 80%, 100% { opacity: 0; }
                40% { opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
